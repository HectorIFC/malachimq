name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

env:
  MIX_ENV: test
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  test:
    name: Test (Elixir ${{matrix.elixir}} / OTP ${{matrix.otp}})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - elixir: '1.19.4'
            otp: '28.1'
            lint: true
            coverage: true
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}
      
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-
      
      - name: ğŸ”¨ Install dependencies
        run: mix deps.get
      
      - name: ğŸ” Check unused dependencies
        run: mix deps.unlock --check-unused
        if: matrix.lint
      
      - name: âš™ï¸ Compile (warnings as errors)
        run: mix compile --warnings-as-errors
        if: matrix.lint
      
      - name: âš™ï¸ Compile (dev)
        run: mix compile
        if: ${{ !matrix.lint }}
      
      - name: ğŸ¨ Check formatting
        run: mix format --check-formatted
        if: matrix.lint
      
      - name: ğŸ” Run Credo (static analysis)
        run: mix credo --strict
        if: matrix.lint
        continue-on-error: true  # Don't fail build on credo warnings
      
      - name: ğŸ§ª Run tests
        run: mix test --trace
      
      - name: ğŸ“Š Generate coverage report
        run: mix coveralls.json
        if: matrix.coverage
      
      - name: ğŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: matrix.coverage
        with:
          files: ./cover/excoveralls.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.19.4'
          otp-version: '28.1'
      
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-security-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-security-
      
      - name: ğŸ”¨ Install dependencies
        run: mix deps.get
      
      - name: ğŸ”’ Check for known security vulnerabilities
        run: mix deps.audit
        continue-on-error: true
      
      - name: ğŸ” Run Sobelow (security analyzer)
        run: |
          mix archive.install hex sobelow --force
          mix sobelow --config
        continue-on-error: true

  docker:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ”¨ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: malachimq:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ğŸ§ª Test Docker image
        run: |
          docker run --rm -d --name malachimq-test \
            -e MALACHIMQ_TCP_PORT=4040 \
            -e MALACHIMQ_DASHBOARD_PORT=4041 \
            -p 4040:4040 \
            -p 4041:4041 \
            malachimq:test
          
          # Wait for container to start
          sleep 10
          
          # Check if container is running
          docker ps | grep malachimq-test
          
          # Check if the application process is running (works without procps on slim images)
          docker exec malachimq-test cat /proc/1/cmdline | tr '\0' ' '
          
          # Check if dashboard is responding on port 4041
          curl -sf http://localhost:4041/metrics || exit 1
          
          # Stop container
          docker stop malachimq-test

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.19.4'
          otp-version: '28.1'
      
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-quality-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-quality-
      
      - name: ğŸ”¨ Install dependencies
        run: mix deps.get
      
      - name: ğŸ“ Check code complexity
        run: |
          mix archive.install hex ex_check --force
          mix check
        continue-on-error: true
      
      - name: ğŸ“ Generate documentation
        run: mix docs
        continue-on-error: true
      
      - name: ğŸ” Check for TODO/FIXME comments
        run: |
          echo "ğŸ“ Checking for TODO/FIXME comments..."
          grep -r "TODO\|FIXME" lib/ || echo "âœ… No TODO/FIXME found"
        continue-on-error: true

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test, security, docker, quality]
    if: always()
    
    steps:
      - name: ğŸ“Š Check results
        run: |
          echo "Test Status: ${{ needs.test.result }}"
          echo "Security Status: ${{ needs.security.result }}"
          echo "Docker Status: ${{ needs.docker.result }}"
          echo "Quality Status: ${{ needs.quality.result }}"
          
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "âŒ Tests failed!"
            exit 1
          fi
          
          if [ "${{ needs.docker.result }}" != "success" ]; then
            echo "âŒ Docker build failed!"
            exit 1
          fi
          
          echo "âœ… All critical checks passed!"
