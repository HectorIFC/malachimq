name: Release & Publish

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  # First, verify that CI passed
  verify-ci:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: üîç Verify CI passed before release
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });
            
            console.log('Check runs for this PR:');
            checkRuns.check_runs.forEach(run => {
              console.log(`- ${run.name}: ${run.conclusion}`);
            });
            
            // Check if CI workflow passed
            const ciRun = checkRuns.check_runs.find(run => run.name.includes('CI Summary'));
            
            if (!ciRun) {
              console.log('‚ö†Ô∏è  CI workflow not found, proceeding anyway');
              return;
            }
            
            if (ciRun.conclusion !== 'success') {
              core.setFailed(`‚ùå CI must pass before release. Current status: ${ciRun.conclusion}`);
              return;
            }
            
            console.log('‚úÖ CI passed, proceeding with release');
  
  release:
    needs: verify-ci
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    outputs:
      new_version: ${{ steps.bump.outputs.NEW_VERSION }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump type
        id: bump_type
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          
          # Check labels first
          if [[ "$PR_LABELS" == *"major"* ]] || [[ "$PR_TITLE" == *"[major]"* ]]; then
            echo "BUMP_TYPE=major" >> $GITHUB_OUTPUT
          elif [[ "$PR_LABELS" == *"minor"* ]] || [[ "$PR_TITLE" == *"[minor]"* ]] || [[ "$PR_TITLE" == *"feat:"* ]]; then
            echo "BUMP_TYPE=minor" >> $GITHUB_OUTPUT
          else
            echo "BUMP_TYPE=patch" >> $GITHUB_OUTPUT
          fi

      - name: Bump version
        id: bump
        run: |
          chmod +x ./scripts/bump-version.sh
          ./scripts/bump-version.sh ${{ steps.bump_type.outputs.BUMP_TYPE }}

      - name: Get new version
        id: version
        run: |
          NEW_VERSION=$(grep '@version' mix.exs | head -1 | sed -E 's/.*"([0-9]+\.[0-9]+\.[0-9]+)".*/\1/')
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # First release
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since last tag
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save changelog to file
          echo "## Changes" > /tmp/changelog.md
          echo "" >> /tmp/changelog.md
          echo "$CHANGELOG" >> /tmp/changelog.md
          
          # Set output for GitHub release
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit version bump
        run: |
          git add mix.exs
          git commit -m "chore: bump version to ${{ steps.version.outputs.NEW_VERSION }}"
          git push origin main

      - name: Create Git tag
        run: |
          git tag -a "v${{ steps.version.outputs.NEW_VERSION }}" -m "Release v${{ steps.version.outputs.NEW_VERSION }}"
          git push origin "v${{ steps.version.outputs.NEW_VERSION }}"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.NEW_VERSION }}
          release_name: Release v${{ steps.version.outputs.NEW_VERSION }}
          body: |
            ## üöÄ MalachiMQ v${{ steps.version.outputs.NEW_VERSION }}
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ### üê≥ Docker
            ```bash
            docker pull hectorcardoso/malachimq:${{ steps.version.outputs.NEW_VERSION }}
            ```
            
            ### üì¶ Installation
            ```bash
            git clone https://github.com/HectorIFC/malachimq.git
            cd malachimq
            git checkout v${{ steps.version.outputs.NEW_VERSION }}
            ```
          draft: false
          prerelease: false

  docker:
    needs: release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.release.outputs.new_version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/malachimq:${{ needs.release.outputs.new_version }}
            ${{ secrets.DOCKER_USERNAME }}/malachimq:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/malachimq:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/malachimq:buildcache,mode=max

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          repository: ${{ secrets.DOCKER_USERNAME }}/malachimq
          short-description: "High-performance message queue built with Elixir/OTP"
          readme-filepath: ./README.md
